<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
  <meta name="format-detection" content="telephone=no" />
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-status-bar-style" content="black" />
  <title>오늘의 호구 : 1초 내기 - Today's Loser</title>

  <!-- Google Fonts: Typography -->
  <link rel="preconnect" href="https://fonts.googleapis.com" />
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
  <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@700;800;900&family=Jua&family=Roboto+Mono:wght@400;700&display=swap" rel="stylesheet" />

  <!-- Tailwind CSS -->
  <script src="https://cdn.tailwindcss.com"></script>

  <style>
    :root {
      --primary-blue: #3182F6;
      --primary-black: #1a1a1a;
      --primary-white: #FFFFFF;
      --bg-light: #F5F5F5;
      --text-dark: #191F28;
      --text-muted: #6B7684;
    }

    * {
      -webkit-user-select: none;
      user-select: none;
      -webkit-touch-callout: none;
      -ms-touch-action: manipulation;
      touch-action: manipulation;
    }

    html, body, #app {
      height: 100%;
      width: 100%;
      margin: 0;
      padding: 0;
    }

    body {
      background: linear-gradient(135deg, #F5F5F5 0%, #EFEFEF 100%);
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Noto Sans KR', sans-serif;
      color: var(--text-dark);
      overflow: hidden;
    }

    /* Typography */
    .font-title {
      font-family: 'Noto Sans KR', sans-serif;
      font-weight: 900;
      letter-spacing: -0.03em;
      line-height: 1.1;
    }

    .font-subtitle {
      font-family: 'Jua', cursive;
      font-weight: 400;
      letter-spacing: -0.01em;
    }

    .font-mono {
      font-family: 'Roboto Mono', monospace;
      font-variant-numeric: tabular-nums;
      font-feature-settings: 'tnum';
    }

    /* Card Elevation */
    .card-elevated {
      background: var(--primary-white);
      border-radius: 24px;
      box-shadow: 0 8px 24px rgba(0, 0, 0, 0.08);
      transition: box-shadow 0.3s ease, transform 0.3s ease;
    }

    .card-elevated:hover {
      box-shadow: 0 12px 32px rgba(0, 0, 0, 0.12);
      transform: translateY(-2px);
    }

    /* Button Styles - 3D Effect */
    .btn-primary {
      background: linear-gradient(135deg, var(--primary-blue) 0%, #2563EB 100%);
      border: none;
      border-radius: 16px;
      font-weight: 700;
      color: var(--primary-white);
      cursor: pointer;
      transition: all 0.2s ease;
      box-shadow: 0 4px 12px rgba(49, 130, 246, 0.3), inset 0 -2px 4px rgba(0, 0, 0, 0.1);
      position: relative;
      overflow: hidden;
    }

    .btn-primary:hover {
      transform: translateY(-2px);
      box-shadow: 0 6px 16px rgba(49, 130, 246, 0.4), inset 0 -2px 4px rgba(0, 0, 0, 0.1);
    }

    .btn-primary:active {
      transform: translateY(0);
      box-shadow: 0 2px 4px rgba(49, 130, 246, 0.2), inset 0 -1px 2px rgba(0, 0, 0, 0.15);
    }

    .btn-secondary {
      background: var(--primary-white);
      border: 2px solid var(--primary-blue);
      border-radius: 16px;
      font-weight: 700;
      color: var(--primary-black);
      cursor: pointer;
      transition: all 0.2s ease;
    }

    .btn-secondary:hover {
      background: rgba(49, 130, 246, 0.1);
      transform: translateY(-2px);
    }

    .btn-secondary:active {
      transform: translateY(0);
    }

    /* Segmented Control */
    .segmented-control {
      display: inline-flex;
      background: rgba(49, 130, 246, 0.1);
      border-radius: 12px;
      padding: 4px;
      gap: 0;
      width: 100%;
    }

    .segmented-control button {
      flex: 1;
      padding: 8px 16px;
      border: none;
      border-radius: 10px;
      background: transparent;
      color: var(--text-muted);
      font-weight: 700;
      cursor: pointer;
      transition: all 0.3s ease;
      font-size: 13px;
    }

    .segmented-control button.active {
      background: var(--primary-blue);
      color: var(--primary-white);
      box-shadow: 0 2px 8px rgba(49, 130, 246, 0.3);
    }

    /* Character Area */
    .character-area {
      width: 120px;
      height: 120px;
      margin: 0 auto;
      display: flex;
      align-items: center;
      justify-content: center;
      background: linear-gradient(135deg, rgba(49, 130, 246, 0.1) 0%, rgba(49, 130, 246, 0.05) 100%);
      border-radius: 20px;
      border: 2px solid rgba(49, 130, 246, 0.3);
      animation: character-float 3s ease-in-out infinite;
    }

    @keyframes character-float {
      0%, 100% { transform: translateY(0); }
      50% { transform: translateY(-8px); }
    }

    /* Timer Display */
    .timer-display {
      font-size: clamp(48px, 15vw, 96px);
      line-height: 1;
      text-align: center;
      color: var(--primary-black);
      font-weight: 900;
      letter-spacing: 0.05em;
    }

    /* Shake Effect */
    @keyframes shake {
      0%, 100% { transform: translateX(0); }
      25% { transform: translateX(-8px); }
      75% { transform: translateX(8px); }
    }

    .shake {
      animation: shake 0.4s ease-in-out;
    }

    /* Confetti Animation */
    @keyframes confetti-fall {
      to {
        transform: translateY(100vh) rotateZ(360deg);
        opacity: 0;
      }
    }

    .confetti {
      position: fixed;
      pointer-events: none;
      z-index: 1000;
      animation: confetti-fall 2.5s ease-out forwards;
    }

    /* Dark Mode Support */
    @media (prefers-color-scheme: dark) {
      body {
        background: linear-gradient(135deg, #1a1a1a 0%, #242424 100%);
      }

      .card-elevated {
        background: #2a2a2a;
        color: #f5f5f5;
      }

      .timer-display {
        color: var(--primary-yellow);
      }

      .segmented-control {
        background: rgba(49, 130, 246, 0.15);
      }

      .character-area {
        background: linear-gradient(135deg, rgba(49, 130, 246, 0.15) 0%, rgba(49, 130, 246, 0.08) 100%);
      }
    }
  </style>
</head>
<body>
  <div id="app" class="flex flex-col items-center justify-center min-h-screen w-full p-2 sm:p-4 overflow-hidden">
    <!-- Canvas for confetti -->
    <canvas id="confettiCanvas" style="position: fixed; top: 0; left: 0; width: 100%; height: 100%; pointer-events: none;"></canvas>

    <div class="w-full max-w-sm mx-auto flex flex-col h-screen overflow-y-auto">
      <!-- Header Section -->
      <div class="text-center py-4 sm:py-5 flex-shrink-0">
        <h1 class="font-title text-4xl sm:text-5xl mb-2 font-black" style="color: var(--primary-black); line-height: 1.2; letter-spacing: -0.02em;">
          오늘의 호구
        </h1>
        <p class="font-subtitle text-xl sm:text-2xl mb-3" style="color: var(--primary-blue); line-height: 1.1;">
          1초 내기
        </p>
        <p class="text-sm sm:text-base text-gray-600 font-medium">정확히 1초를 맞춰보세요</p>
      </div>

      <!-- Main Card -->
      <div class="card-elevated p-4 sm:p-6 mb-4 flex-shrink-0">
        <!-- Best Record - Compact -->
        <div class="text-center mb-4 pb-3 border-b border-gray-200" style="min-height: auto;">
          <p class="text-xs text-gray-500 mb-1">최고 기록</p>
          <p id="bestRecordDisplay" class="text-xl font-bold" style="color: var(--primary-blue); line-height: 1;">
            없음
          </p>
          <p id="bestDiffDisplay" class="text-xs text-gray-400 mt-0.5"></p>
        </div>

        <!-- Mode Selector - Compact -->
        <div class="mb-4">
          <p class="text-xs text-gray-500 mb-2 ml-1">모드</p>
          <div class="segmented-control">
            <button class="mode-btn active text-xs sm:text-sm" data-mode="1">1.0초</button>
            <button class="mode-btn text-xs sm:text-sm" data-mode="3">3.0초</button>
            <button class="mode-btn text-xs sm:text-sm" data-mode="5">5.0초</button>
          </div>
        </div>

        <!-- Character Area - Optimized size -->
        <div class="character-area mb-4" style="width: 100px; height: 100px; margin: 0 auto;" id="characterArea">
          <svg width="90" height="90" viewBox="0 0 100 100" xmlns="http://www.w3.org/2000/svg">
            <!-- Dog body -->
            <ellipse cx="50" cy="60" rx="28" ry="32" fill="#D4A574" stroke="#8B6F47" stroke-width="1.5"/>
            
            <!-- Dog head -->
            <circle cx="50" cy="35" r="22" fill="#D4A574" stroke="#8B6F47" stroke-width="1.5"/>
            
            <!-- Left ear -->
            <ellipse cx="35" cy="18" rx="8" ry="12" fill="#D4A574" stroke="#8B6F47" stroke-width="1.5" transform="rotate(-25 35 18)"/>
            
            <!-- Right ear -->
            <ellipse cx="65" cy="18" rx="8" ry="12" fill="#D4A574" stroke="#8B6F47" stroke-width="1.5" transform="rotate(25 65 18)"/>
            
            <!-- Snout -->
            <ellipse cx="50" cy="42" rx="12" ry="10" fill="#E8C9A0" stroke="#8B6F47" stroke-width="1.5"/>
            
            <!-- Left eye -->
            <circle cx="44" cy="32" r="2.5" fill="#000000"/>
            
            <!-- Right eye -->
            <circle cx="56" cy="32" r="2.5" fill="#000000"/>
            
            <!-- Eyes shine -->
            <circle cx="44.5" cy="31" r="1" fill="#FFFFFF"/>
            <circle cx="56.5" cy="31" r="1" fill="#FFFFFF"/>
            
            <!-- Nose -->
            <ellipse cx="50" cy="42" rx="3" ry="2.5" fill="#8B6F47"/>
            
            <!-- Mouth -->
            <path d="M 50 42 Q 47 46 44 44" stroke="#8B6F47" stroke-width="1.5" fill="none" stroke-linecap="round"/>
            <path d="M 50 42 Q 53 46 56 44" stroke="#8B6F47" stroke-width="1.5" fill="none" stroke-linecap="round"/>
            
            <!-- Left paw -->
            <ellipse cx="38" cy="88" rx="6" ry="8" fill="#D4A574" stroke="#8B6F47" stroke-width="1"/>
            
            <!-- Right paw -->
            <ellipse cx="62" cy="88" rx="6" ry="8" fill="#D4A574" stroke="#8B6F47" stroke-width="1"/>
            
            <!-- Tail wave -->
            <path d="M 25 65 Q 15 55 18 40" stroke="#D4A574" stroke-width="8" fill="none" stroke-linecap="round" stroke-linejoin="round"/>
          </svg>
        </div>

        <!-- Character Message - Compact -->
        <div class="text-center mb-3">
          <p id="characterMessage" class="font-subtitle text-sm sm:text-base px-2" style="color: var(--primary-black); min-height: 28px; line-height: 1.3;">
            흠... 1초면 쉽지 않나?
          </p>
        </div>

        <!-- Timer Display - Optimized -->
        <div class="mb-4 py-3">
          <div class="timer-display font-mono text-3xl sm:text-5xl" id="timerDisplay">
            ?.????
          </div>
          <p id="statusMsg" class="text-center text-xs sm:text-sm text-gray-500 mt-2">
            시작 버튼을 눌러주세요
          </p>
        </div>

        <!-- Result Section -->
        <div id="resultSection" class="hidden mb-3 p-3 rounded-lg" style="background: rgba(49, 130, 246, 0.1); border: 1px solid rgba(49, 130, 246, 0.3);">
          <p id="resultText" class="text-center font-bold text-sm sm:text-base mb-1"></p>
          <p id="resultSubtext" class="text-center text-xs text-gray-600"></p>
        </div>

        <!-- Action Buttons - Compact -->
        <div class="flex gap-2 mb-3">
          <button id="actionBtn" class="btn-primary flex-1 px-4 py-3 text-base font-bold rounded-lg" style="min-height: auto; line-height: 1;">
            시작
          </button>
          <button id="shareBtn" class="btn-secondary flex-1 px-4 py-3 text-base font-bold rounded-lg" style="min-height: auto; line-height: 1;">
            공유
          </button>
        </div>

        <!-- Ads Placeholder - Minimal -->
        <div id="toss-ad-banner" class="h-12 flex items-center justify-center border border-dashed border-gray-300 rounded-lg text-xs text-gray-400 bg-gray-50" style="opacity: 0.7;">
          Toss Ads
        </div>
      </div>

      <!-- Footer - Minimal -->
      <footer class="text-center text-xs text-gray-400 mt-3 mb-2 px-2 leading-tight flex-shrink-0">
        <p>(주)옐로우독 소프트 | 대왕누렁이</p>
        <p class="mt-0.5">help@yellowdog.soft</p>
        <p class="mt-0.5 text-gray-500">© 2026 Yellow Dog Soft</p>
      </footer>
    </div>
  </div>

  <script type="module">
    // ============================================================
    // GAME STATE & CONFIGURATION
    // ============================================================
    const STORAGE_KEY = 'today_hogu_best';
    const stateEnum = { IDLE: 'IDLE', RUNNING: 'RUNNING', RESULT: 'RESULT' };

    let appState = stateEnum.IDLE;
    let startTime = 0;
    let rafId = null;
    let targetSeconds = 1.0;
    let lastDuration = null;
    let currentMode = 1;

    // DOM Elements
    const timerDisplay = document.getElementById('timerDisplay');
    const actionBtn = document.getElementById('actionBtn');
    const shareBtn = document.getElementById('shareBtn');
    const statusMsg = document.getElementById('statusMsg');
    const resultSection = document.getElementById('resultSection');
    const resultText = document.getElementById('resultText');
    const resultSubtext = document.getElementById('resultSubtext');
    const bestRecordDisplay = document.getElementById('bestRecordDisplay');
    const bestDiffDisplay = document.getElementById('bestDiffDisplay');
    const characterMessage = document.getElementById('characterMessage');
    const characterArea = document.getElementById('characterArea');
    const modeButtons = document.querySelectorAll('.mode-btn');
    const modeDesc = document.getElementById('modeDesc');
    const confettiCanvas = document.getElementById('confettiCanvas');

    // ============================================================
    // ANALYTICS & LOGGING
    // ============================================================
    function logEvent(eventName, params = {}) {
      console.log(`[Analytics] ${eventName}`, params);
    }

    // ============================================================
    // STORAGE & UI UPDATE
    // ============================================================
    function loadBest() {
      try {
        const raw = localStorage.getItem(STORAGE_KEY);
        return raw ? JSON.parse(raw) : null;
      } catch (e) {
        console.error('Failed to load best record:', e);
        return null;
      }
    }

    function saveBest(best) {
      try {
        localStorage.setItem(STORAGE_KEY, JSON.stringify(best));
      } catch (e) {
        console.error('Failed to save best record:', e);
      }
    }

    function updateBestUI() {
      const best = loadBest();
      if (!best) {
        bestRecordDisplay.textContent = '없음';
        bestDiffDisplay.textContent = '';
        return;
      }
      bestRecordDisplay.textContent = `${best.duration.toFixed(4)}초`;
      bestDiffDisplay.textContent = `오차 ${best.diff.toFixed(4)}초`;
    }

    // ============================================================
    // STATE MACHINE
    // ============================================================
    function setState(nextState) {
      appState = nextState;
      renderState();
    }

    function renderState() {
      if (appState === stateEnum.IDLE) {
        actionBtn.textContent = '시작';
        actionBtn.classList.add('btn-primary');
        actionBtn.classList.remove('btn-secondary');
        timerDisplay.textContent = '?.????';
        statusMsg.textContent = '시작 버튼을 눌러주세요';
        resultSection.classList.add('hidden');
        
        // Mode-specific idle messages
        if (targetSeconds === 1) {
          characterMessage.textContent = '흠... 1초면 쉽지 않나요?';
        } else if (targetSeconds === 3) {
          characterMessage.textContent = '3초? 할 만한데요?';
        } else if (targetSeconds === 5) {
          characterMessage.textContent = '5초라니, 너무 길지 않나요?';
        }
      } else if (appState === stateEnum.RUNNING) {
        actionBtn.textContent = '정지';
        actionBtn.classList.add('btn-secondary');
        actionBtn.classList.remove('btn-primary');
        timerDisplay.textContent = '?.????';
        statusMsg.textContent = '정확하게 멈춰보세요!';
        characterMessage.textContent = '오... 그래, 한 번 해봐요.';
      } else if (appState === stateEnum.RESULT) {
        actionBtn.textContent = '다시하기';
        actionBtn.classList.add('btn-primary');
        actionBtn.classList.remove('btn-secondary');
        resultSection.classList.remove('hidden');
      }
    }

    // ============================================================
    // GAME LOGIC
    // ============================================================
    function fmtSec(s) {
      return s.toFixed(4);
    }

    function vibrate(pattern) {
      if (navigator.vibrate) navigator.vibrate(pattern);
    }

    function loop() {
      const now = performance.now();
      const duration = (now - startTime) / 1000;
      lastDuration = duration;
      rafId = requestAnimationFrame(loop);
    }

    function stopAndEvaluate() {
      if (rafId) cancelAnimationFrame(rafId);
      const endTime = performance.now();
      const duration = (endTime - startTime) / 1000;
      lastDuration = duration;
      const rounded = Math.round(duration * 10000) / 10000;
      const diff = Math.abs(rounded - targetSeconds);

      timerDisplay.textContent = fmtSec(rounded) + '초';

      const perfect = Math.abs(rounded - targetSeconds) === 0;
      const nearMiss = diff <= 0.01 && !perfect;

      vibrate(30);

      if (perfect) {
        vibrate([100, 50, 100]);
        
        // Mode-specific success messages
        if (targetSeconds === 1) {
          resultText.textContent = `오호! 이것도 맞추셨어요?`;
          resultSubtext.textContent = '실력이 있으신가봐요... 믿기지 않네요.';
          characterMessage.textContent = '어... 정말이네요?';
        } else if (targetSeconds === 3) {
          resultText.textContent = `오호! 정말 할 만 하네요?`;
          resultSubtext.textContent = '3초를 정확히 맞추시네요. 신기한데요?';
          characterMessage.textContent = '어? 정말이네요.';
        } else if (targetSeconds === 5) {
          resultText.textContent = `오호! 5초를 정확히요?`;
          resultSubtext.textContent = '5초도 맞추시네요. 솜씨가 있으신가봐요.';
          characterMessage.textContent = '오... 5초를요?';
        }
        
        launchConfetti();
        playSuccessAnimation();
      } else if (nearMiss) {
        if (targetSeconds === 1) {
          resultText.textContent = `아까워요. ${fmtSec(rounded)}초`;
          resultSubtext.textContent = `오차 ${diff.toFixed(4)}초 - 거의 다 왔어요.`;
          characterMessage.textContent = '아이고... 아까워요.';
        } else if (targetSeconds === 3) {
          resultText.textContent = `어라? ${fmtSec(rounded)}초네요.`;
          resultSubtext.textContent = `오차 ${diff.toFixed(4)}초 - 거의 맞추신 것 같은데요?`;
          characterMessage.textContent = '아, 아까워요.';
        } else if (targetSeconds === 5) {
          resultText.textContent = `어? ${fmtSec(rounded)}초네요.`;
          resultSubtext.textContent = `오차 ${diff.toFixed(4)}초 - 거의 맞추셨어요.`;
          characterMessage.textContent = '거의였는데요...';
        }
        playNearMissAnimation();
      } else {
        if (targetSeconds === 1) {
          resultText.textContent = `에라 모르겠어요. ${fmtSec(rounded)}초`;
          resultSubtext.textContent = `오차 ${diff.toFixed(4)}초 - 역시 어렵네요.`;
          characterMessage.textContent = '역시... 어렵네요.';
        } else if (targetSeconds === 3) {
          resultText.textContent = `아뇨. ${fmtSec(rounded)}초네요.`;
          resultSubtext.textContent = `오차 ${diff.toFixed(4)}초 - 3초는 어렵나봐요.`;
          characterMessage.textContent = '3초는... 힘들지요?';
        } else if (targetSeconds === 5) {
          resultText.textContent = `5초는 아니네요. ${fmtSec(rounded)}초.`;
          resultSubtext.textContent = `오차 ${diff.toFixed(4)}초 - 5초가 힘들군요.`;
          characterMessage.textContent = '5초는 어려운가봐요.';
        }
        playFailAnimation();
      }

      const prev = loadBest();
      const candidate = {
        duration: rounded,
        diff,
        mode: targetSeconds,
        iso: new Date().toISOString()
      };

      if (!prev || candidate.mode !== prev.mode || candidate.diff < prev.diff) {
        saveBest(candidate);
        if (perfect || nearMiss) {
          vibrate([50, 30, 50, 30, 50]);
        }
      }
      updateBestUI();

      logEvent('game_result', {
        mode: targetSeconds,
        duration: rounded,
        diff,
        is_perfect: perfect,
        is_near_miss: nearMiss
      });

      setState(stateEnum.RESULT);
    }

    // ============================================================
    // ANIMATIONS
    // ============================================================
    function playSuccessAnimation() {
      characterArea.style.animation = 'none';
      setTimeout(() => {
        characterArea.style.animation = 'character-float 3s ease-in-out infinite';
      }, 10);
      // Update SVG color or add celebration
    }

    function playFailAnimation() {
      const card = document.querySelector('.card-elevated');
      card.classList.add('shake');
      setTimeout(() => card.classList.remove('shake'), 400);
    }

    function playNearMissAnimation() {
      // Slight shake
      const card = document.querySelector('.card-elevated');
      card.style.animation = 'shake 0.2s ease-in-out';
      setTimeout(() => { card.style.animation = 'none'; }, 200);
    }

    function launchConfetti() {
      const canvas = confettiCanvas;
      const ctx = canvas.getContext('2d');
      canvas.width = window.innerWidth;
      canvas.height = window.innerHeight;

      const particles = [];
      const colors = ['#3182F6', '#2563EB', '#1a1a1a', '#FFFFFF'];

      for (let i = 0; i < 100; i++) {
        particles.push({
          x: Math.random() * canvas.width,
          y: -20,
          vx: (Math.random() - 0.5) * 8,
          vy: Math.random() * 6 + 3,
          size: Math.random() * 8 + 4,
          color: colors[Math.floor(Math.random() * colors.length)],
          rot: Math.random() * 360,
          rotSpeed: (Math.random() - 0.5) * 15
        });
      }

      function animate() {
        ctx.clearRect(0, 0, canvas.width, canvas.height);
        for (let p of particles) {
          p.x += p.vx;
          p.y += p.vy;
          p.vy += 0.2;
          p.rot += p.rotSpeed;

          ctx.save();
          ctx.translate(p.x, p.y);
          ctx.rotate(p.rot * Math.PI / 180);
          ctx.fillStyle = p.color;
          ctx.fillRect(-p.size / 2, -p.size / 2, p.size, p.size * 0.6);
          ctx.restore();
        }

        particles = particles.filter(p => p.y < canvas.height + 40);
        if (particles.length > 0) requestAnimationFrame(animate);
        else ctx.clearRect(0, 0, canvas.width, canvas.height);
      }

      requestAnimationFrame(animate);
    }

    // ============================================================
    // CONFETTI COLORS
    // ============================================================
    function getConfettiColors() {
      return ['#3182F6', '#2563EB', '#1a1a1a', '#FFFFFF'];
    }

    // ============================================================
    // EVENT HANDLERS
    // ============================================================
    actionBtn.addEventListener('click', (e) => {
      e.preventDefault();
      actionBtn.disabled = true;
      setTimeout(() => (actionBtn.disabled = false), 300);

      if (appState === stateEnum.IDLE) {
        startTime = performance.now();
        setState(stateEnum.RUNNING);
        vibrate(20);
        logEvent('game_start', { mode: targetSeconds });
        rafId = requestAnimationFrame(loop);
      } else if (appState === stateEnum.RUNNING) {
        stopAndEvaluate();
      } else if (appState === stateEnum.RESULT) {
        setState(stateEnum.IDLE);
      }
    });

    shareBtn.addEventListener('click', async () => {
      vibrate(30);
      const rounded = lastDuration ? Math.round(lastDuration * 10000) / 10000 : null;
      const best = loadBest();

      let shareTitle = '오늘의 호구 : 1초 내기';
      let shareText = '';

      if (rounded && appState === stateEnum.RESULT) {
        const diff = Math.abs(rounded - targetSeconds);
        shareText = `내 기록: ${rounded.toFixed(4)}초 (${targetSeconds}초 모드)\n`;
        shareText += `오차: ${diff.toFixed(4)}초\n\n`;
        if (best && best.mode === targetSeconds) {
          shareText += `최고 기록: ${best.duration.toFixed(4)}초\n`;
        }
        shareText += `너도 도전해봐! 1초를 맞출 수 있나?`;
      } else {
        shareText = `정확히 ${targetSeconds}초에 타이머를 멈춰보세요!\n\n너는 호구? 천재? 함께 도전해봐!`;
      }

      if (navigator.share) {
        try {
          await navigator.share({ title: shareTitle, text: shareText });
          logEvent('share_success', { method: 'native' });
        } catch (err) {
          if (err.name !== 'AbortError') {
            fallbackShare(shareText);
          }
        }
      } else {
        fallbackShare(shareText);
      }
    });

    function fallbackShare(text) {
      if (navigator.clipboard?.writeText) {
        navigator.clipboard.writeText(text).then(() => {
          alert('공유 문구가 복사되었습니다!\n\n카카오톡이나 문자로 공유해보세요.');
          logEvent('share_success', { method: 'clipboard' });
        });
      } else {
        alert(text);
      }
    }

    modeButtons.forEach((btn) => {
      btn.addEventListener('click', () => {
        const m = Number(btn.dataset.mode);
        targetSeconds = m;
        currentMode = m;

        modeButtons.forEach((b) => b.classList.remove('active'));
        btn.classList.add('active');

        setState(stateEnum.IDLE);
        updateBestUI();
        logEvent('mode_changed', { mode: m });
      });
    });

    // ============================================================
    // INITIALIZATION
    // ============================================================
    function init() {
      updateBestUI();
      setState(stateEnum.IDLE);
      logEvent('app_launch', { timestamp: new Date().toISOString() });
      logEvent('ad_impression', { type: 'banner' });

      document.addEventListener(
        'touchmove',
        (e) => {
          if (appState === stateEnum.RUNNING) e.preventDefault();
        },
        { passive: false }
      );

      window.addEventListener('resize', () => {
        confettiCanvas.width = window.innerWidth;
        confettiCanvas.height = window.innerHeight;
      });
    }

    init();

    window.__gameState = { setState, stopAndEvaluate, loadBest, logEvent };
  </script>
</body>
</html>
